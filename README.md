# HamArc — помехоустойчивый архиватор (.haf)

HamArc — консольный архиватор , объединяющий несколько файлов в один архив формата **.haf**.
Для повышения устойчивости к ошибкам хранения/передачи данные кодируются с использованием **кодов Хэмминга**.

## Возможности

- Создание архива из одного или нескольких файлов
- Просмотр содержимого архива (имена и размеры)
- Извлечение всех файлов или выбранных по имени
- Добавление файлов в существующий архив (append)
- Удаление файлов из архива (delete)
- Объединение нескольких архивов в один (concatenate)
- Попытка восстановления при повреждениях (либо корректное сообщение об ошибке)

## Использование (CLI)

Ровно один режим за запуск:

- `-c, --create` — создать архив
- `-l, --list` — вывести список файлов в архиве
- `-x, --extract` — извлечь файлы (если имена не указаны — извлечь все)
- `-a, --append` — добавить файлы в архив
- `-d, --delete` — удалить файлы из архива
- `-A, --concatenate` — объединить несколько архивов в один

Обязательный параметр архива:

- `-f, --file=ARCHIVE` — путь к архиву `.haf`

Параметры кодов Хэмминга (по умолчанию `-D 8 -P 4`):

- `-D, --hamming-data-bits` — число информационных бит (k), диапазон 1..16
- `-P, --hamming-parity-bits` — число проверочных бит (r), диапазон 1..8

### Примеры

```bash
hamarc --create --file=archive.haf file1.bin file2.bin
```

```bash
hamarc --list --file=archive.haf
```

```bash
# извлечь все файлы в текущую директорию
hamarc --extract --file=archive.haf
```

```bash
# извлечь только один файл (имя должно совпадать с именем в архиве)
hamarc --extract --file=archive.haf file2.bin
```

```bash
hamarc --append --file=archive.haf new_file.bin
```

```bash
hamarc --delete --file=archive.haf old_file.bin
```

```bash
# объединить два архива в третий
hamarc --concatenate --file=merged.haf a1.haf a2.haf
```

> Важно: при добавлении файлов в архив сохраняется только имя файла (basename).
> При извлечении файлы записываются в **текущую рабочую директорию** (куда вы запускаете `hamarc`).

## Формат архива (.haf) — кратко

Архив состоит из заголовка и данных файлов.

**Заголовок:**
- сигнатура `HAF` (3 байта)
- `uint32_t file_count`
- для каждого файла:
  - `uint16_t name_length`
  - `name` (байты имени)
  - `uint64_t original_size`
  - `uint64_t encoded_size`
  - `uint64_t offset`

**Данные:** подряд идут закодированные (Хэмминг) блоки файлов.

## Сборка

Проект рассчитан на сборку через **CMake** (рекомендуется).

```bash
cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
cmake --build build --config Release
```

После сборки бинарник `hamarc` используется в тестах и при ручном запуске.

## Тестирование

В проект добавлен набор **автотестов на GoogleTest** (интеграционные тесты CLI).  
Тесты запускают `hamarc` как отдельный процесс и проверяют результат по коду возврата,
файлам на диске и выводу команды `--list`.

### Запуск тестов

```bash
ctest --test-dir build -C Release --output-on-failure
```

### Что проверяют тесты

Набор тестов покрывает ключевые сценарии:

- `create → list → extract` с проверкой совпадения файлов **байт-в-байт**
- извлечение одного файла по имени
- `append` добавляет файлы и они корректно извлекаются
- `delete` удаляет файл, а попытка удалить несуществующий файл завершается ошибкой
- `concatenate` объединяет архивы; при конфликте имён выполняется переименование `name(2)`, `name(3)` и т.д.
- негативные сценарии: поврежденная сигнатура архива (ожидается отказ)
- сценарий с пользовательскими параметрами `-D/-P` и имитацией одиночной битовой ошибки (проверка устойчивости)

### Примечание по ресурсам тестов

Базовый тест использует тестовые файлы (например, изображение/документ).
Для корректной сборки тестов должны быть заданы compile-time параметры:

- `RESOURCES_DIR` — путь к папке с тестовыми ресурсами
- `HAMARC_EXE_PATH` — путь к собранному бинарнику `hamarc`

(В CMake это обычно делается через `target_compile_definitions(...)` для таргета тестов.)

## CI/CD

Для автоматической проверки в репозитории может быть настроен GitHub Actions workflow
(`.github/workflows/main.yml`), который на каждый `push`/`pull_request`:

1) собирает проект на `ubuntu-latest` и `windows-latest`;  
2) запускает тесты через `ctest`.
